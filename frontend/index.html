<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 Plateforme d'Analyse Sémantique Avancée</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f8fafc;
            color: #334155;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 48px 0;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 12px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.3rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            padding: 32px;
            margin: 24px 0;
            border: 1px solid #e2e8f0;
        }

        .upload-zone {
            border: 3px dashed #cbd5e1;
            border-radius: 16px;
            padding: 56px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            position: relative;
        }

        .upload-zone:hover {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            transform: translateY(-2px);
            box-shadow: 0 20px 40px -10px rgba(59, 130, 246, 0.15);
        }

        .upload-zone.drag-over {
            border-color: #10b981;
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .btn {
            padding: 14px 28px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .progress-container {
            margin: 32px 0;
            padding: 24px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 16px;
            border: 1px solid #e2e8f0;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background-color: #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #10b981, #f59e0b);
            border-radius: 8px;
            transition: width 0.5s ease;
            width: 0%;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: progress-shine 2s infinite;
        }

        @keyframes progress-shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin: 32px 0;
        }

        .metric-card {
            text-align: center;
            padding: 28px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.15);
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #10b981, #f59e0b);
        }

        .metric-value {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 12px;
            position: relative;
            z-index: 1;
        }

        .metric-value.positive { 
            color: #10b981; 
            text-shadow: 0 2px 10px rgba(16, 185, 129, 0.3);
        }
        .metric-value.negative { 
            color: #ef4444; 
            text-shadow: 0 2px 10px rgba(239, 68, 68, 0.3);
        }
        .metric-value.neutral { 
            color: #f59e0b; 
            text-shadow: 0 2px 10px rgba(245, 158, 11, 0.3);
        }
        .metric-value.info { 
            color: #3b82f6; 
            text-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
        }

        .metric-label {
            font-size: 1rem;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-subtitle {
            font-size: 0.85rem;
            color: #94a3b8;
            margin-top: 8px;
            font-style: italic;
        }

        .download-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            margin: 40px 0;
            position: relative;
            overflow: hidden;
        }

        .download-section::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 50%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .download-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 32px;
            flex-wrap: wrap;
            position: relative;
            z-index: 1;
        }

        .download-btn {
            padding: 18px 36px;
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            backdrop-filter: blur(10px);
        }

        .download-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .alert {
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            position: relative;
            border-left: 4px solid;
        }

        .alert-error {
            background-color: #fef2f2;
            border-left-color: #ef4444;
            color: #dc2626;
        }

        .alert-success {
            background-color: #f0fdf4;
            border-left-color: #10b981;
            color: #059669;
        }

        .alert-info {
            background-color: #eff6ff;
            border-left-color: #3b82f6;
            color: #1d4ed8;
        }

        .hidden {
            display: none;
        }

        .loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        select, input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background-color: white;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .insight-card {
            margin-bottom: 20px;
            padding: 24px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 16px;
            border-left: 5px solid #3b82f6;
            transition: all 0.3s ease;
            position: relative;
        }

        .insight-card:hover {
            transform: translateX(4px);
            box-shadow: 0 10px 30px -5px rgba(59, 130, 246, 0.2);
        }

        .insight-title {
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 12px;
            font-size: 1.1rem;
        }

        .insight-description {
            color: #64748b;
            line-height: 1.7;
        }

        .new-metrics-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 24px 0;
        }

        .sentiment-net-display {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 24px;
            border-radius: 16px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .sentiment-net-display.negative {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .sentiment-net-display.neutral {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .sentiment-gauge {
            width: 100px;
            height: 50px;
            margin: 0 auto 16px;
            position: relative;
            border-radius: 100px 100px 0 0;
            background: rgba(255,255,255,0.2);
            overflow: hidden;
        }

        .gauge-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 100%;
            background: rgba(255,255,255,0.8);
            transition: width 0.8s ease;
            border-radius: 100px 100px 0 0;
        }

        .theme-preview {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            border: 1px solid #e2e8f0;
        }

        .theme-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .theme-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #64748b;
        }

        .keyword-cloud {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .keyword-tag {
            background: #e0f2fe;
            color: #0369a1;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .container { padding: 0 16px; }
            .header h1 { font-size: 2.2rem; }
            .results-grid { grid-template-columns: 1fr; }
            .download-buttons { flex-direction: column; align-items: center; }
            .new-metrics-section { grid-template-columns: 1fr; }
        }

        /* Animation d'entrée pour les résultats */
        .fade-in {
            animation: fadeIn 0.6s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>🚀 Plateforme d'Analyse Sémantique Avancée</h1>
            <p>Analysez vos avis clients avec l'IA + Social Listening + Insights Stratégiques</p>
        </div>
    </div>

    <div class="container">
        <!-- Progress Bar -->
        <div id="progress-container" class="progress-container hidden">
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                <span style="font-weight: 600;">🔄 Progression de l'Analyse</span>
                <span id="progress-text" style="font-weight: 700; color: #3b82f6;">0%</span>
            </div>
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
            <div id="progress-status" style="text-align: center; margin-top: 12px; color: #64748b; font-weight: 500;"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="resetAnalysis()" class="btn btn-primary">🔄 Nouvelle Analyse</button>
            </div>
        </div>

        <!-- Upload Zone -->
        <div id="upload-section" class="card fade-in">
            <div id="upload-zone" class="upload-zone" onclick="document.getElementById('file-input').click()">
                <div class="upload-icon">📊</div>
                <h3 style="margin-bottom: 12px; font-size: 1.4rem;">Glissez-déposez votre fichier ou cliquez pour sélectionner</h3>
                <p style="font-size: 1.1rem; color: #64748b;">Formats supportés : CSV, Excel (.xlsx, .xls) • Taille max : 100MB</p>
                <input type="file" id="file-input" accept=".csv,.xlsx,.xls" style="display: none;" onchange="handleFileSelect(event)">
                <div id="file-info" class="hidden" style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-radius: 12px; display: inline-block; border: 1px solid #93c5fd;">
                    <p id="file-name" style="color: #1d4ed8; font-weight: 700; font-size: 1.1rem;"></p>
                </div>
            </div>
        </div>

        <!-- Column Selection -->
        <div id="column-section" class="card hidden fade-in">
            <h3 style="margin-bottom: 20px; font-size: 1.5rem; color: #1e293b;">⚙️ Configuration de l'analyse</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 32px;">
                <div>
                    <label style="display: block; margin-bottom: 12px; font-weight: 700; color: #374151; font-size: 1.1rem;">
                        📝 Sélectionnez la colonne contenant les avis :
                    </label>
                    <select id="column-select">
                        <option value="">Choisir une colonne...</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 12px; font-weight: 700; color: #374151; font-size: 1.1rem;">
                        📊 Informations du fichier :
                    </label>
                    <div style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0;">
                        <p style="margin-bottom: 8px;"><strong>📄 Lignes :</strong> <span id="row-count" style="color: #3b82f6; font-weight: 700;">0</span></p>
                        <p><strong>📋 Colonnes :</strong> <span id="column-count" style="color: #10b981; font-weight: 700;">0</span></p>
                    </div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 32px;">
                <button onclick="startAnalysis()" class="btn btn-primary" style="font-size: 1.2rem; padding: 18px 40px;">
                    🧠 Lancer l'Analyse Avancée
                </button>
            </div>
        </div>

        <!-- Error Display -->
        <div id="error-section" class="alert alert-error hidden">
            <strong>❌ Erreur :</strong> <span id="error-message"></span>
        </div>

        <!-- Results -->
        <div id="results-section" class="hidden">
            <!-- Métriques Principales Enrichies -->
            <div class="card fade-in">
                <h2 style="margin-bottom: 32px; font-size: 2rem; color: #1e293b;">📊 Résultats de l'Analyse Avancée</h2>
                
                <!-- Sentiment Net en vedette -->
                <div id="sentiment-net-section" class="sentiment-net-display" style="margin-bottom: 32px;">
                    <h3 style="margin-bottom: 16px; font-size: 1.3rem;">🎯 Sentiment Net Global</h3>
                    <div class="sentiment-gauge">
                        <div id="sentiment-gauge-fill" class="gauge-fill"></div>
                    </div>
                    <div id="sentiment-net-value" style="font-size: 2.5rem; font-weight: 800; margin-bottom: 8px;">0%</div>
                    <div id="sentiment-net-label" style="opacity: 0.9; font-size: 1.1rem;">Calcul en cours...</div>
                </div>

                <div id="metrics-grid" class="results-grid"></div>
                
                <!-- Nouvelles métriques -->
                <div id="advanced-metrics" class="new-metrics-section"></div>
            </div>

            <!-- Aperçu des Thèmes -->
            <div id="themes-preview-section" class="card fade-in hidden">
                <h3 style="margin-bottom: 20px; font-size: 1.6rem; color: #1e293b;">🎯 Aperçu des Thèmes Identifiés</h3>
                <div id="themes-preview-container"></div>
            </div>

            <!-- Insights Enrichis -->
            <div id="insights-section" class="card fade-in">
                <h3 style="margin-bottom: 20px; font-size: 1.6rem; color: #1e293b;">💡 Insights Stratégiques</h3>
                <div id="insights-container"></div>
            </div>

            <!-- Éléments Contextuels -->
            <div id="contextual-section" class="card fade-in hidden">
                <h3 style="margin-bottom: 20px; font-size: 1.6rem; color: #1e293b;">🔍 Éléments Contextuels</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;">
                    <div id="emoji-preview"></div>
                    <div id="hashtag-preview"></div>
                    <div id="mention-preview"></div>
                </div>
            </div>

            <!-- Section de Téléchargement Améliorée -->
            <div id="download-section" class="download-section">
                <h3 style="margin-bottom: 12px; font-size: 1.8rem;">📥 Télécharger les Résultats Complets</h3>
                <p style="opacity: 0.9; margin-bottom: 0; font-size: 1.1rem;">
                    Exportez votre analyse complète avec métriques détaillées, graphiques et recommandations stratégiques
                </p>
                <div class="download-buttons">
                    <a id="pdf-download" href="#" class="download-btn" target="_blank">
                        📄 Rapport PDF Exécutif
                    </a>
                    <a id="excel-download" href="#" class="download-btn" target="_blank">
                        📊 Données Excel Détaillées
                    </a>
                </div>
                
                <div style="margin-top: 24px; padding: 16px; background: rgba(255,255,255,0.1); border-radius: 12px; position: relative; z-index: 1;">
                    <p style="font-size: 0.9rem; opacity: 0.8;">
                        📋 <strong>Contenu inclus :</strong> Sentiment Net par thème, Nuages d'emojis et hashtags, 
                        Analyse des sous-thèmes, Recommandations stratégiques, Graphiques interactifs
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'https://semantic-analysis-7ogp.onrender.com';
        
        // État global
        let fileInfo = null;
        let sessionId = null;
        let analysisResults = null;

        // Debug: Logger les erreurs
        function logError(message, error) {
            console.error('🚨 ERREUR:', message, error);
            showError(`${message}: ${error.message || error}`);
        }

        // Debug: Logger les succès
        function logSuccess(message, data) {
            console.log('✅ SUCCÈS:', message, data);
        }

        // Test de connexion API
        async function testBackendConnection() {
            try {
                console.log('🔄 Test connexion backend:', API_BASE_URL);
                const response = await fetch(`${API_BASE_URL}/health`);
                const data = await response.json();
                logSuccess('Backend connecté', data);
                return true;
            } catch (error) {
                logError('Backend non accessible', error);
                return false;
            }
        }

        // Tester la connexion au chargement
        window.addEventListener('load', () => {
            testBackendConnection();
        });

        // Gestion du drag & drop
        const uploadZone = document.getElementById('upload-zone');
        
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('drag-over');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('drag-over');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        // Gestion de la sélection de fichier
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        // Traitement du fichier
        async function handleFile(file) {
            console.log('📁 Fichier sélectionné:', file.name, file.size, 'bytes');
            
            // Vérifications de base
            if (file.size > 100 * 1024 * 1024) {
                showError('Fichier trop volumineux (max 100MB)');
                return;
            }

            if (!file.name.match(/\.(csv|xlsx|xls)$/i)) {
                showError('Format non supporté. Utilisez CSV ou Excel.');
                return;
            }

            document.getElementById('file-name').textContent = `✅ Fichier sélectionné : ${file.name}`;
            document.getElementById('file-info').classList.remove('hidden');
            
            showProgress(10, 'Téléchargement et analyse du fichier...');
            hideError();

            const formData = new FormData();
            formData.append('file', file);

            try {
                console.log('🚀 Envoi vers:', `${API_BASE_URL}/upload`);
                
                const response = await fetch(`${API_BASE_URL}/upload`, {
                    method: 'POST',
                    body: formData,
                    mode: 'cors'
                });

                console.log('📡 Réponse reçue:', response.status, response.statusText);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                logSuccess('Upload réussi', result);

                if (result.success) {
                    fileInfo = result;
                    populateColumns(result.columns);
                    document.getElementById('row-count').textContent = result.rowCount.toLocaleString();
                    document.getElementById('column-count').textContent = result.columns.length;
                    
                    showProgress(30, 'Fichier traité, configuration de l\'analyse...');
                    document.getElementById('column-section').classList.remove('hidden');
                } else {
                    throw new Error(result.error || 'Erreur upload inconnue');
                }
            } catch (error) {
                logError('Erreur upload', error);
                resetProgress();
            }
        }

        // Remplir la liste des colonnes
        function populateColumns(columns) {
            const select = document.getElementById('column-select');
            select.innerHTML = '<option value="">Choisir une colonne...</option>';
            
            columns.forEach(column => {
                const option = document.createElement('option');
                option.value = column;
                option.textContent = column;
                select.appendChild(option);
            });

            // Auto-sélection intelligente de la première colonne de texte
            const textColumns = columns.filter(col => 
                col.toLowerCase().includes('avis') || 
                col.toLowerCase().includes('comment') || 
                col.toLowerCase().includes('text') || 
                col.toLowerCase().includes('review')
            );
            if (textColumns.length > 0) {
                select.value = textColumns[0];
            } else if (columns.length > 0) {
                select.value = columns[0];
            }
        }

        // Lancer l'analyse
        async function startAnalysis() {
            const selectedColumn = document.getElementById('column-select').value;
            
            if (!selectedColumn) {
                showError('Veuillez sélectionner une colonne à analyser');
                return;
            }

            showProgress(50, 'Analyse sémantique en cours...');
            hideError();

            try {
                console.log('🧠 Lancement analyse avancée...');
                
                const response = await fetch(`${API_BASE_URL}/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        data: fileInfo.preview,
                        textColumn: selectedColumn
                    }),
                    mode: 'cors'
                });

                console.log('📊 Réponse analyse:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                logSuccess('Analyse avancée réussie', result);

                if (result.success) {
                    sessionId = result.sessionId;
                    analysisResults = result.results;
                    
                    showProgress(80, 'Génération des visualisations...');
                    setTimeout(() => {
                        displayAdvancedResults(result.results);
                        showProgress(100, 'Analyse terminée avec succès !');
                    }, 1000);
                } else {
                    throw new Error(result.error || 'Erreur analyse inconnue');
                }
            } catch (error) {
                logError('Erreur analyse', error);
                resetProgress();
            }
        }

        // Afficher les résultats avancés
        function displayAdvancedResults(results) {
            console.log('📈 Affichage des résultats avancés:', results);
            
            // 1. Sentiment Net en vedette
            displaySentimentNet(results.metrics.sentiment);
            
            // 2. Métriques principales
            displayMainMetrics(results);
            
            // 3. Métriques avancées
            displayAdvancedMetrics(results.metrics);
            
            // 4. Aperçu des thèmes
            displayThemesPreview(results.themes);
            
            // 5. Insights stratégiques
            displayAdvancedInsights(results.insights);
            
            // 6. Éléments contextuels
            displayContextualElements(results);
            
            // 7. Liens de téléchargement
            setupDownloadLinks();
            
            // 8. Afficher les sections
            document.getElementById('results-section').classList.remove('hidden');
            document.querySelectorAll('.fade-in').forEach(el => {
                el.style.animation = 'fadeIn 0.6s ease-in';
            });
        }

        // Affichage du Sentiment Net
        function displaySentimentNet(sentimentMetrics) {
            if (!sentimentMetrics) return;

            const sentimentNet = sentimentMetrics.sentimentNet || 0;
            const netSection = document.getElementById('sentiment-net-section');
            const gaugeValue = document.getElementById('sentiment-net-value');
            const gaugeLabel = document.getElementById('sentiment-net-label');
            const gaugeFill = document.getElementById('sentiment-gauge-fill');

            // Mise à jour des valeurs
            gaugeValue.textContent = `${(sentimentNet * 100).toFixed(1)}%`;
            
            // Définition du label et de la couleur
            let label, className;
            if (sentimentNet > 0.3) {
                label = 'Excellent - Très positif';
                className = '';
            } else if (sentimentNet > 0.1) {
                label = 'Bon - Globalement positif';
                className = '';
            } else if (sentimentNet > -0.1) {
                label = 'Mitigé - Équilibré';
                className = 'neutral';
            } else if (sentimentNet > -0.3) {
                label = 'Préoccupant - Plutôt négatif';
                className = 'negative';
            } else {
                label = 'Critique - Très négatif';
                className = 'negative';
            }

            gaugeLabel.textContent = label;
            netSection.className = `sentiment-net-display ${className}`;

            // Animation de la jauge
            const gaugeWidth = Math.abs(sentimentNet) * 100;
            setTimeout(() => {
                gaugeFill.style.width = `${Math.min(gaugeWidth, 100)}%`;
            }, 500);
        }

        // Affichage des métriques principales
        function displayMainMetrics(results) {
            const metricsGrid = document.getElementById('metrics-grid');
            const sentiment = results.metrics.sentiment;
            const themes = results.metrics.themes;
            const global = results.metrics.global;
            
            if (!sentiment) {
                metricsGrid.innerHTML = '<p class="text-gray-500">Métriques de sentiment non disponibles</p>';
                return;
            }

            metricsGrid.innerHTML = `
                <div class="metric-card">
                    <div class="metric-value info">${(results.summary?.totalReviews || sentiment.total || 0).toLocaleString()}</div>
                    <div class="metric-label">Avis analysés</div>
                    <div class="metric-subtitle">Volume total traité</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value positive">${sentiment.percentages.positif.toFixed(1)}%</div>
                    <div class="metric-label">Avis Positifs</div>
                    <div class="metric-subtitle">${sentiment.counts.positif.toLocaleString()} avis</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value negative">${sentiment.percentages.négatif.toFixed(1)}%</div>
                    <div class="metric-label">Avis Négatifs</div>
                    <div class="metric-subtitle">${sentiment.counts.négatif.toLocaleString()} avis</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value neutral">${sentiment.percentages.neutre.toFixed(1)}%</div>
                    <div class="metric-label">Avis Neutres</div>
                    <div class="metric-subtitle">${sentiment.counts.neutre.toLocaleString()} avis</div>
                </div>
                ${themes ? `
                <div class="metric-card">
                    <div class="metric-value info">${themes.totalThemes || 0}</div>
                    <div class="metric-label">Thèmes Identifiés</div>
                    <div class="metric-subtitle">Analyse thématique</div>
                </div>
                ` : ''}
                ${global ? `
                <div class="metric-card">
                    <div class="metric-value ${global.healthScore > 70 ? 'positive' : global.healthScore > 40 ? 'neutral' : 'negative'}">${global.healthScore}/100</div>
                    <div class="metric-label">Score de Santé</div>
                    <div class="metric-subtitle">${global.interpretation?.health || 'Évaluation globale'}</div>
                </div>
                ` : ''}
            `;
        }

        // Affichage des métriques avancées
        function displayAdvancedMetrics(metrics) {
            const advancedSection = document.getElementById('advanced-metrics');
            
            let html = '';
            
            // Confiance moyenne
            if (metrics.sentiment?.avgConfidence) {
                const confidence = metrics.sentiment.avgConfidence * 100;
                html += `
                    <div class="metric-card">
                        <div class="metric-value ${confidence > 70 ? 'positive' : confidence > 50 ? 'neutral' : 'negative'}">${confidence.toFixed(1)}%</div>
                        <div class="metric-label">Confiance Moyenne</div>
                        <div class="metric-subtitle">Fiabilité de l'analyse</div>
                    </div>
                `;
            }
            
            // Polarisation
            if (metrics.sentiment?.polarization) {
                const polarization = metrics.sentiment.polarization;
                html += `
                    <div class="metric-card">
                        <div class="metric-value ${polarization > 0.6 ? 'negative' : polarization > 0.3 ? 'neutral' : 'positive'}">${polarization.toFixed(2)}</div>
                        <div class="metric-label">Polarisation</div>
                        <div class="metric-subtitle">${metrics.sentiment.polarizationLevel || 'Dispersion des opinions'}</div>
                    </div>
                `;
            }
            
            // Diversité thématique
            if (metrics.themes?.diversity) {
                const diversity = metrics.themes.diversity;
                html += `
                    <div class="metric-card">
                        <div class="metric-value info">${diversity.toFixed(2)}</div>
                        <div class="metric-label">Diversité Thématique</div>
                        <div class="metric-subtitle">${metrics.themes.diversityLevel || 'Richesse du contenu'}</div>
                    </div>
                `;
            }
            
            advancedSection.innerHTML = html;
        }

        // Affichage de l'aperçu des thèmes
        function displayThemesPreview(themesData) {
            if (!themesData || !themesData.themes || themesData.themes.length === 0) return;
            
            const previewContainer = document.getElementById('themes-preview-container');
            const previewSection = document.getElementById('themes-preview-section');
            
            const topThemes = themesData.themes.slice(0, 5);
            
            let html = '';
            topThemes.forEach((theme, index) => {
                const sentimentNet = (theme.sentimentNet || 0) * 100;
                const sentimentColor = sentimentNet > 10 ? '#10b981' : sentimentNet < -10 ? '#ef4444' : '#f59e0b';
                
                html += `
                    <div class="theme-preview">
                        <div class="theme-title">${index + 1}. ${theme.name}</div>
                        <div class="theme-stats">
                            <span><strong>${theme.size}</strong> avis (${theme.percentage}%)</span>
                            <span style="color: ${sentimentColor}; font-weight: 600;">
                                Sentiment Net: ${sentimentNet.toFixed(1)}%
                            </span>
                        </div>
                        ${theme.keywords && theme.keywords.length > 0 ? `
                            <div class="keyword-cloud">
                                ${theme.keywords.slice(0, 5).map(kw => 
                                    `<span class="keyword-tag">${typeof kw === 'string' ? kw : kw.word}</span>`
                                ).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            previewContainer.innerHTML = html;
            previewSection.classList.remove('hidden');
        }

        // Affichage des insights avancés
        function displayAdvancedInsights(insights) {
            const insightsContainer = document.getElementById('insights-container');
            
            if (!insights || insights.length === 0) {
                insightsContainer.innerHTML = `
                    <div class="insight-card">
                        <div class="insight-title">🔍 Analyse en cours</div>
                        <div class="insight-description">Les insights stratégiques seront disponibles une fois l'analyse complète terminée.</div>
                    </div>
                `;
                return;
            }

            const topInsights = insights.slice(0, 5);
            let html = '';
            
            topInsights.forEach(insight => {
                const typeEmoji = {
                    'positive': '✅',
                    'warning': '⚠️',
                    'alert': '🚨',
                    'info': 'ℹ️',
                    'summary': '📊'
                };
                
                const priorityColors = {
                    'high': '#ef4444',
                    'medium': '#f59e0b',
                    'low': '#64748b'
                };
                
                html += `
                    <div class="insight-card" style="border-left-color: ${priorityColors[insight.priority] || '#3b82f6'};">
                        <div class="insight-title">
                            ${typeEmoji[insight.type] || '💡'} ${insight.title}
                            <span style="float: right; font-size: 0.8rem; color: ${priorityColors[insight.priority] || '#3b82f6'}; font-weight: 500;">
                                ${insight.priority ? insight.priority.toUpperCase() : 'INFO'}
                            </span>
                        </div>
                        <div class="insight-description">${insight.description}</div>
                        ${insight.recommendations && insight.recommendations.length > 0 ? `
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e2e8f0;">
                                <strong style="color: #1e40af; font-size: 0.9rem;">🎯 Actions recommandées :</strong>
                                <ul style="margin-top: 8px; padding-left: 20px; color: #64748b; font-size: 0.9rem;">
                                    ${insight.recommendations.slice(0, 3).map(rec => `<li style="margin-bottom: 4px;">${rec}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            insightsContainer.innerHTML = html;
        }

        // Affichage des éléments contextuels
        function displayContextualElements(results) {
            const contextualSection = document.getElementById('contextual-section');
            const emojiPreview = document.getElementById('emoji-preview');
            const hashtagPreview = document.getElementById('hashtag-preview');
            const mentionPreview = document.getElementById('mention-preview');
            
            let hasContextualData = false;
            
            // Emojis
            if (results.emojis && results.emojis.length > 0) {
                hasContextualData = true;
                const topEmojis = results.emojis.slice(0, 8);
                emojiPreview.innerHTML = `
                    <h4 style="margin-bottom: 12px; color: #1e293b; font-weight: 600;">😊 Top Emojis</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${topEmojis.map(emoji => `
                            <span style="background: #fef3c7; padding: 8px 12px; border-radius: 20px; font-size: 1.1rem; border: 1px solid #fbbf24;">
                                ${emoji.emoji} <span style="font-size: 0.8rem; color: #92400e;">(${emoji.count})</span>
                            </span>
                        `).join('')}
                    </div>
                `;
            }
            
            // Hashtags
            if (results.hashtags && results.hashtags.length > 0) {
                hasContextualData = true;
                const topHashtags = results.hashtags.slice(0, 6);
                hashtagPreview.innerHTML = `
                    <h4 style="margin-bottom: 12px; color: #1e293b; font-weight: 600;"># Top Hashtags</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${topHashtags.map(hashtag => `
                            <span style="background: #dcfce7; padding: 6px 12px; border-radius: 16px; font-size: 0.9rem; color: #166534; border: 1px solid #22c55e;">
                                ${hashtag.hashtag || hashtag.tag} <span style="font-size: 0.8rem;">(<strong>${hashtag.count}</strong>)</span>
                            </span>
                        `).join('')}
                    </div>
                `;
            }
            
            // Mentions
            if (results.mentions && results.mentions.length > 0) {
                hasContextualData = true;
                const topMentions = results.mentions.slice(0, 5);
                mentionPreview.innerHTML = `
                    <h4 style="margin-bottom: 12px; color: #1e293b; font-weight: 600;">@ Top Mentions</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${topMentions.map(mention => `
                            <span style="background: #e0e7ff; padding: 6px 12px; border-radius: 16px; font-size: 0.9rem; color: #3730a3; border: 1px solid #6366f1;">
                                ${mention.mention} <span style="font-size: 0.8rem;">(<strong>${mention.count}</strong>)</span>
                            </span>
                        `).join('')}
                    </div>
                `;
            }
            
            if (hasContextualData) {
                contextualSection.classList.remove('hidden');
            }
        }

        // Configuration des liens de téléchargement
        function setupDownloadLinks() {
            if (sessionId) {
                document.getElementById('pdf-download').href = `${API_BASE_URL}/export/pdf/${sessionId}`;
                document.getElementById('excel-download').href = `${API_BASE_URL}/export/excel/${sessionId}`;
            }
        }

        // Utilitaires UI
        function showProgress(percent, message) {
            document.getElementById('progress-container').classList.remove('hidden');
            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('column-section').classList.add('hidden');
            
            document.getElementById('progress-fill').style.width = `${percent}%`;
            document.getElementById('progress-text').textContent = `${percent}%`;
            document.getElementById('progress-status').textContent = message;
        }

        function resetProgress() {
            document.getElementById('progress-container').classList.add('hidden');
            document.getElementById('upload-section').classList.remove('hidden');
            document.getElementById('column-section').classList.add('hidden');
            document.getElementById('results-section').classList.add('hidden');
            document.getElementById('file-info').classList.add('hidden');
            document.getElementById('progress-fill').style.width = '0%';
        }

        function resetAnalysis() {
            fileInfo = null;
            sessionId = null;
            analysisResults = null;
            document.getElementById('file-input').value = '';
            resetProgress();
            hideError();
            
            // Masquer les sections optionnelles
            document.getElementById('themes-preview-section').classList.add('hidden');
            document.getElementById('contextual-section').classList.add('hidden');
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-section').classList.remove('hidden');
            
            // Auto-hide après 10 secondes
            setTimeout(() => {
                hideError();
            }, 10000);
        }

        function hideError() {
            document.getElementById('error-section').classList.add('hidden');
        }

        // Animation d'amélioration de l'expérience utilisateur
        document.addEventListener('DOMContentLoaded', function() {
            // Animation de typing pour le titre
            const title = document.querySelector('.header h1');
            if (title) {
                title.style.opacity = '0';
                setTimeout(() => {
                    title.style.opacity = '1';
                    title.style.animation = 'fadeIn 1s ease-in';
                }, 500);
            }
            
            // Parallax léger sur l'header
            window.addEventListener('scroll', () => {
                const scrolled = window.pageYOffset;
                const rate = scrolled * -0.3;
                const header = document.querySelector('.header');
                if (header) {
                    header.style.transform = `translateY(${rate}px)`;
                }
            });
        });
    </script>
</body>
</html>
